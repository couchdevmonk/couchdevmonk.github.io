<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Scoreboard</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,500,0,0');

@font-face {
    font-family: 'JetBrainsMono';
    src: url('JetBrainsMono-Regular.ttf') format('truetype');
}

:root{
    --bg:#111;
    --fg:#eee;
    --border:#2a2a2a;
    --accent:#c65a4f;
    --sticky-name-width:220px;
    --sticky-final-width:110px;
}

body.light{
    --bg:#fff;
    --fg:#111;
    --border:#e5e5e5;
}

html,body{
    margin:0;
    height:100%;
    background:var(--bg);
    color:var(--fg);
    font-family:'JetBrainsMono', monospace;
    overflow:hidden;
}

.app{
    height:100%;
    display:flex;
    flex-direction:column;
    padding:40px 70px;
    box-sizing:border-box;
}

/* HEADER */

.header{
    display:grid;
    grid-template-columns:1fr auto;
    align-items:center;
    margin-bottom:8px;
}

.header-controls{
    justify-self:end;
    display:flex;
    gap:8px;
    align-items:center;
}

h1{
    margin:0;
    text-align:center;
    font-weight:600;
    font-size:24px;
}

h1:focus{
    outline:none;
    border-bottom:1px solid var(--accent);
}

.toggle{
    cursor:pointer;
    opacity:1;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:32px;
    height:32px;
    border:1px solid var(--border);
    border-radius:8px;
    background-color:color-mix(in srgb, var(--fg) 8%, var(--bg));
    font-size:0;
    line-height:1;
    transition:background-color .15s ease, border-color .15s ease, transform .15s ease;
}
.toggle:hover{
    background-color:color-mix(in srgb, var(--fg) 14%, var(--bg));
    border-color:color-mix(in srgb, var(--accent) 60%, var(--border));
    transform:translateY(-1px);
}
.toggle .material-symbols-outlined{
    font-size:20px;
    line-height:1;
    font-variation-settings: 'FILL' 0, 'wght' 500, 'GRAD' 0, 'opsz' 24;
}

.reset-btn{
    cursor:pointer;
    border:1px solid var(--border);
    border-radius:8px;
    background-color:color-mix(in srgb, var(--fg) 6%, var(--bg));
    color:var(--fg);
    font-family:inherit;
    font-size:12px;
    padding:7px 10px;
    line-height:1;
    transition:background-color .15s ease, border-color .15s ease, transform .15s ease;
}
.reset-btn:hover{
    background-color:color-mix(in srgb, var(--fg) 12%, var(--bg));
    border-color:color-mix(in srgb, var(--accent) 60%, var(--border));
    transform:translateY(-1px);
}

.reset-all-btn{
    background-color:color-mix(in srgb, var(--accent) 18%, var(--bg));
    border-color:color-mix(in srgb, var(--accent) 55%, var(--border));
}

.target-row{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    padding-top:8px;
    margin-bottom:28px;
    font-size:14px;
}

.target-row input{
    width:90px;
    padding:4px 6px;
    background:none;
    border:none;
    border-bottom:1px solid var(--border);
    color:var(--fg);
    font-family:inherit;
    text-align:right;
}

.target-row input:focus{
    outline:none;
    border-bottom:1px solid var(--accent);
}

/* TABLE */

.table-wrapper{
    flex:1;
    overflow:auto;
}

table{
    border-collapse:separate;
    border-spacing:0;
    width:max-content;
}

th,td{
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    white-space:nowrap;
    background-color:var(--bg);
}

th{
    font-weight:500;
    color:color-mix(in srgb, var(--fg) 60%, transparent);
}

/* STICKY HEADER */
thead th{
    position:sticky;
    top:0;
    z-index:50;
    background:var(--bg);
}

/* STICKY NAME COLUMN */
.name-col{
    position:sticky;
    left:0;
    z-index:40;
    text-align:left;
    width:var(--sticky-name-width);
    min-width:var(--sticky-name-width);
    background-color:var(--bg);
    box-shadow:1px 0 0 var(--border);
}

/* STICKY FINAL COLUMN */
.final-col{
    text-align:right;
    position:sticky;
    left:var(--sticky-name-width);
    z-index:35;
    width:var(--sticky-final-width);
    min-width:var(--sticky-final-width);
    max-width:var(--sticky-final-width);
    box-sizing:border-box;
    background-color:var(--bg);
    box-shadow:1px 0 0 var(--border);
}

/* ensure header sticky cells are highest */
thead .name-col{ z-index:60; }
thead .final-col{ z-index:55; }

/* ROUND */
.round-col{
    width:65px;
    text-align:right;
}

.score-input{
    width:65px;
}

/* Remove number arrows */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{
    -webkit-appearance:none;
    margin:0;
}
input[type=number]{
    -moz-appearance:textfield;
}

td input{
    border:none;
    background:none;
    color:var(--fg);
    font-family:inherit;
    text-align:right;
}

.name-col input{
    width:100%;
    box-sizing:border-box;
}

td input:focus{
    outline:none;
    border-bottom:1px solid var(--accent);
}

/* Add button */
.add{
    cursor:pointer;
    opacity:0.4;
}
.add:hover{ opacity:1; }

.final-toggle{
    cursor:pointer;
}

.add-player-bar{
    border-top:1px solid var(--border);
    padding:12px 16px;
    background-color:var(--bg);
}

/* Winner */
@keyframes winnerFade {
    from { background: transparent; }
    to { background: rgba(198,90,79,0.12); }
}

.winner-row {
    background: rgba(198,90,79,0.12);
}

.winner-row .name-col{
    color:var(--accent);
    font-weight:600;
}

.winner-label{
    font-size:12px;
    margin-right:8px;
    opacity:0.8;
}

</style>
</head>

<body>
<div class="app">

<div class="header">
    <h1 contenteditable="true" id="sessionTitle">Game Session</h1>
    <div class="header-controls">
        <button class="reset-btn" onclick="resetScores()">Reset Scores</button>
        <button class="reset-btn reset-all-btn" onclick="resetBoard()">Reset All</button>
        <div class="toggle" onclick="toggleMode()" aria-label="Toggle theme" title="Toggle theme">
            <span class="material-symbols-outlined">dark_mode</span>
        </div>
    </div>
</div>

<div class="target-row">
    Target
    <input type="number" id="targetInput">
</div>

<div class="table-wrapper">
<table>
<thead>
<tr id="headerRow"></tr>
</thead>
<tbody id="bodyRows"></tbody>
</table>
</div>
<div id="addPlayerBar" class="add-player-bar add">+ Add Player</div>

</div>

<script>
let data = JSON.parse(localStorage.getItem("stableFinalScoreboard")) || {
    session:"Game Session",
    players:[],
    rounds:0,
    target:null,
    winnerSorted:false,
    showRemaining:false
};
if(data.showRemaining===undefined){
    data.showRemaining=false;
}

function save(){
    localStorage.setItem("stableFinalScoreboard", JSON.stringify(data));
}

function computeFinal(p){
    if(data.rounds===0) return p.score||0;
    return p.rounds.reduce((a,b)=>a+b,0);
}

function computeRemaining(final){
    if(data.target===null || data.target===undefined) return "-";
    return Math.max(data.target-final,0);
}

function checkWinner(){
    if(!data.target) return null;
    for(let i=0;i<data.players.length;i++){
        if(computeFinal(data.players[i])>=data.target){
            return i;
        }
    }
    return null;
}

function maybeSortWinner(){
    const winnerIndex = checkWinner();
    if(winnerIndex===null) return;

    if(!data.winnerSorted){
        const winner = data.players.splice(winnerIndex,1)[0];
        data.players.unshift(winner);
        data.winnerSorted=true;
        save();
    }
}

function toggleFinalView(){
    if(data.rounds===0) return;
    data.showRemaining=!data.showRemaining;
    save();
    render();
}

function render(){
    maybeSortWinner();

    const headerRow=document.getElementById("headerRow");
    const body=document.getElementById("bodyRows");
    headerRow.innerHTML="";
    body.innerHTML="";

    headerRow.innerHTML+=`<th class="name-col">Name</th>`;

    if(data.rounds===0){
        headerRow.innerHTML+=`<th class="final-col">Score</th>`;
    } else {
        headerRow.innerHTML+=`<th class="final-col final-toggle" title="Click to toggle Final / Remaining" onclick="toggleFinalView()">${data.showRemaining ? "Remaining" : "Final"}</th>`;
    }

    for(let r=0;r<data.rounds;r++){
        headerRow.innerHTML+=`<th class="round-col">R${r+1}</th>`;
    }

    headerRow.innerHTML+=`<th class="add" onclick="addRound()">+</th>`;

    const winnerIndex = checkWinner();

    data.players.forEach((p,i)=>{
        const final=computeFinal(p);
        const row=document.createElement("tr");

        if(i===winnerIndex){
            row.classList.add("winner-row");
            row.style.animation="winnerFade 0.6s ease forwards";
        }

        let winnerLabel = i===winnerIndex ? `<span class="winner-label">Winner!</span>` : "";

        row.innerHTML=`
        <td class="name-col">
            ${winnerLabel}
            <input style="text-align:left"
            value="${p.name||''}"
            onchange="updateName(${i},this.value)">
        </td>
        `;

        if(data.rounds===0){
            row.innerHTML+=`
            <td class="final-col">
                <input type="number"
                class="score-input"
                value="${p.score||0}"
                onchange="updateScore(${i},this.value)">
            </td>`;
        } else {
            const finalDisplay = data.showRemaining ? computeRemaining(final) : final;
            row.innerHTML+=`
            <td class="final-col">${finalDisplay}</td>`;
        }

        p.rounds?.forEach((score,r)=>{
            row.innerHTML+=`
            <td class="round-col">
                <input type="number"
                class="score-input"
                value="${score}"
                onchange="updateRound(${i},${r},this.value)">
            </td>`;
        });

        row.innerHTML+=`
        <td class="add" onclick="removePlayer(${i})">Ã—</td>`;

        body.appendChild(row);
    });

    document.getElementById("addPlayerBar").onclick = addPlayer;

    document.getElementById("sessionTitle").innerText=data.session;
    document.getElementById("targetInput").value=data.target||"";
}

function addPlayer(){
    data.players.push({
        name:"Player",
        score:0,
        rounds:Array(data.rounds).fill(0)
    });
    save(); render();
}

function removePlayer(i){
    data.players.splice(i,1);
    save(); render();
}

function addRound(){
    data.rounds++;
    data.players.forEach(p=>{
        p.rounds = p.rounds || [];
        p.rounds.push(0);
    });
    save(); render();
}

function updateName(i,val){
    data.players[i].name=val;
    save();
}

function updateScore(i,val){
    data.players[i].score=parseInt(val)||0;
    save(); render();
}

function updateRound(i,r,val){
    data.players[i].rounds[r]=parseInt(val)||0;
    save(); render();
}

document.getElementById("sessionTitle").addEventListener("input",e=>{
    data.session=e.target.innerText;
    save();
});

document.getElementById("targetInput").addEventListener("change",e=>{
    const v=parseInt(e.target.value);
    data.target=isNaN(v)?null:v;
    data.winnerSorted=false;
    save(); render();
});

function toggleMode(){
    document.body.classList.toggle("light");
}

function resetBoard(){
    const confirmed = confirm("Reset everything? This will remove all players, rounds, target, and session title.");
    if(!confirmed) return;
    data = {
        session:"Game Session",
        players:[],
        rounds:0,
        target:null,
        winnerSorted:false,
        showRemaining:false
    };
    save();
    render();
}

function resetScores(){
    const confirmed = confirm("Reset all scores? This will keep players and rounds, but set scores back to 0.");
    if(!confirmed) return;

    data.players = (data.players || []).map(p=>({
        ...p,
        score:0,
        rounds:Array(data.rounds).fill(0)
    }));
    data.winnerSorted=false;

    save();
    render();
}

render();
</script>

</body>
</html>
